<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<style>
h1,
h2,
h3,
h4,
h5,
h6,
p,
blockquote {
    margin: 0;
    padding: 0;
}
body {
    font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", Arial, sans-serif;
    font-size: 13px;
    line-height: 18px;
    color: #737373;
    background-color: white;
    margin: 10px 13px 10px 13px;
}
table {
	margin: 10px 0 15px 0;
	border-collapse: collapse;
}
td,th {	
	border: 1px solid #ddd;
	padding: 3px 10px;
}
th {
	padding: 5px 10px;	
}

a {
    color: #0069d6;
}
a:hover {
    color: #0050a3;
    text-decoration: none;
}
a img {
    border: none;
}
p {
    margin-bottom: 9px;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    color: #404040;
    line-height: 36px;
}
h1 {
    margin-bottom: 18px;
    font-size: 30px;
}
h2 {
    font-size: 24px;
}
h3 {
    font-size: 18px;
}
h4 {
    font-size: 16px;
}
h5 {
    font-size: 14px;
}
h6 {
    font-size: 13px;
}
hr {
    margin: 0 0 19px;
    border: 0;
    border-bottom: 1px solid #ccc;
}
blockquote {
    padding: 13px 13px 21px 15px;
    margin-bottom: 18px;
    font-family:georgia,serif;
    font-style: italic;
}
blockquote:before {
    content:"\201C";
    font-size:40px;
    margin-left:-10px;
    font-family:georgia,serif;
    color:#eee;
}
blockquote p {
    font-size: 14px;
    font-weight: 300;
    line-height: 18px;
    margin-bottom: 0;
    font-style: italic;
}
code, pre {
    font-family: Monaco, Andale Mono, Courier New, monospace;
}
code {
    background-color: #fee9cc;
    color: rgba(0, 0, 0, 0.75);
    padding: 1px 3px;
    font-size: 12px;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
}
pre {
    display: block;
    padding: 14px;
    margin: 0 0 18px;
    line-height: 16px;
    font-size: 11px;
    border: 1px solid #d9d9d9;
    white-space: pre-wrap;
    word-wrap: break-word;
}
pre code {
    background-color: #fff;
    color:#737373;
    font-size: 11px;
    padding: 0;
}
sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:10px auto;
    }
}
@media print {
	body,code,pre code,h1,h2,h3,h4,h5,h6 {
		color: black;
	}
	table, pre {
		page-break-inside: avoid;
	}
}
</style>
<title>容联云红包集成文档</title>

</head>
<body>
<h1>容联云红包集成文档</h1>

<h2>1. 导入redpacketlibrary简介</h2>

<p><strong>redpacketlibrary</strong>，在容联云<strong>Yuntx_FullLib_v5.2.1r.jar</strong>的基础上提供了收发红包和零钱页的功能。</p>

<h2>2. 集成步骤（红包领取消息不计数，请你处理）</h2>

<h3>2.1 添加对红包工程的依赖</h3>

<ul>
<li>YTXAndroid的build.gradle中</li>
</ul>


<pre><code>    compile project(':redpacketlibrary')
    compile fileTree(dir: 'libs', include: ['*.jar'])
    compile 'com.android.support:appcompat-v7:20.0.0'
</code></pre>

<ul>
<li>YTXAndroid的setting.gradle中</li>
</ul>


<pre><code>   include ':app', ':redpacketlibrary'
</code></pre>

<h3>2.2在ECApplication中初始化红包和设置刷新签名</h3>

<pre><code>
     @Override
    public void onCreate() {
        super.onCreate();
        instance = this;
        CCPAppManager.setContext(instance);
        FileAccessor.initFileAccess();
        setChattingContactId();
        initImageLoader();
        CrashHandler.getInstance().init(this);
        SDKInitializer.initialize(instance);
        //红包SDK的注册上下文
        RedPacket.getInstance().initContext(this, RPConstant.AUTH_METHOD_SIGN);
        //打开Log开关，正式发布需要关闭
        RedPacket.getInstance().setDebugMode(true);
        //刷新签名机制
        RedPacket.getInstance().setRefreshSignListener(new RPRefreshSignListener() {
            @Override
            public void onRefreshSign(RPValueCallback&lt;TokenData&gt; rpValueCallback) {
                ClientUser clientUser = CCPAppManager.getClientUser();
                RedPacketUtil.getInstance().requestSign
                (ECApplication.this,clientUser.getUserId(),rpValueCallback);
            }
        });
    }
</code></pre>

<h3>2.3 YTXAndroid清单文件中注册红包相关组件</h3>

<pre><code>
    &lt;uses-sdk
        android:minSdkVersion="9"
        android:targetSdkVersion="21"
        tools:overrideLibrary="com.yunzhanghu.redpacketui" /&gt;

    &lt;!--红包相关界面 start--&gt;
        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPRedPacketActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustPan|stateVisible"
            /&gt;
        &lt;activity

            android:name="com.yunzhanghu.redpacketui.ui.activity.RPDetailActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustPan"
            /&gt;

        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPRecordActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustPan"
            /&gt;

        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPWebViewActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustResize|stateHidden"
            /&gt;
        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPChangeActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustResize|stateHidden"
            /&gt;
        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPBankCardActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustPan|stateHidden"
            &gt;&lt;/activity&gt;

        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPGroupMemberActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustPan|stateHidden"
            /&gt;
        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPTransferActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustPan|stateVisible"
            /&gt;
        &lt;activity
            android:name="com.yunzhanghu.redpacketui.ui.activity.RPTransferDetailActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustPan|stateHidden"
            /&gt;

        &lt;activity
            android:name="com.alipay.sdk.app.H5PayActivity"
            android:configChanges="orientation|keyboardHidden|navigation|screenSize"
            android:exported="false"
            android:screenOrientation="behind"
            android:windowSoftInputMode="adjustResize|stateHidden"
            /&gt;
    &lt;!--红包相关界面 end--&gt;
</code></pre>

<h3>2.4 在聊天页拓展消息类型中增加“红包”的发送入口</h3>

<ul>
<li>在AppPanelControl.java中增加消息扩展栏红包的按钮</li>
</ul>


<pre><code>    package com.yuntongxun.ecdemo.ui.chatting;

    public int[] cap = new int[] { ...,R.string.attach_red_packet,...};
    public int[] capVoip = new int[] { ...,R.string.attach_red_packet,...};
    private Capability getCapability(int resid) {

       Capability capability = null;

        switch (resid) {
        ...
        ...
        //红包按钮
        case R.string.attach_red_packet:

        capability = new Capability(getContext().getString(R.string.attach_red_packet), R.drawable.ytx_chat_redpacket_selector);

        break;

        default:

        break;
        }   
</code></pre>

<ul>
<li>在AppPanel.java设置红包按钮的监听事件。</li>
</ul>


<pre><code>
    package com.yuntongxun.ecdemo.ui.chatting.vew;

       final AppGrid.OnCapabilityItemClickListener mCapabilityItemClickListener
            = new AppGrid.OnCapabilityItemClickListener() {

        @Override
        public void onPanleItemClick(int index, int capabilityId, String capabilityName) {
           ....
            switch (capabilityId) {
                   ...
                case R.string.attach_red_packet:
                    mAppPanelItemClickListener.OnSelectRedPacketClick();
                    break;

                default:
                    break;
            }
        }
    };

    public interface OnAppPanelItemClickListener {
        .....
        void OnSelectRedPacketClick();

    }
</code></pre>

<ul>
<li>在CCPChattingFooter2中设置</li>
</ul>


<pre><code>
    package com.yuntongxun.ecdemo.ui.chatting.view;

    final private AppPanel.OnAppPanelItemClickListener  mAppPanelItemClickListener
            = new AppPanel.OnAppPanelItemClickListener() {

        @Override
        public void OnTakingPictureClick() {
        .........

        @Override
        public void OnSelectRedPacketClick() {
            // TODO Auto-generated method stub
            if(mChattingPanelClickListener != null) {
                mChattingPanelClickListener.OnSelectRedPacketRequest();
            }

        }

    };
</code></pre>

<h3>2.5 发送红包</h3>

<ul>
<li>在ChattingFragment.java中点击红包按钮打开发送红包界面</li>
</ul>


<pre><code>
      package com.yuntongxun.ecdemo.ui.chatting;

     /**
     * 聊天插件功能实现
     */
    private class OnOnChattingPanelImpl implements CCPChattingFooter2.OnChattingPanelClickListener {

    .....

        @Override
        public void OnSelectRedPacketRequest() {//红包
            RedPacketInfo redPacketInfo = new RedPacketInfo();
            //传递参数到红包sdk：发送者头像url，昵称（缺失则传id）
            String fromAvatarUrl = "none";//开发者换成自己app的图像 
            String fromNickName = clientUser.getUserName();
            fromNickName = TextUtils.isEmpty(fromNickName) ? clientUser.getUserId() : fromNickName;
            redPacketInfo.fromAvatarUrl = fromAvatarUrl;//发送者头像
            redPacketInfo.fromNickName = fromNickName;//发送者昵称
            if (!isPeerChat()) {
                //如果是单聊传递对方id
                redPacketInfo.toUserId = mRecipients;
                redPacketInfo.chatType = RPConstant.CHATTYPE_SINGLE;//单聊
            } else {
                //如果是群聊传递群id和群人数
                ECGroup ecGroup = GroupSqlManager.getECGroup(mRecipients);
                redPacketInfo.toGroupId = ecGroup.getGroupId();
                redPacketInfo.chatType = RPConstant.CHATTYPE_GROUP;//群聊
                redPacketInfo.groupMemberCount = ecGroup.getCount();//群成员个数
            }
            Intent intent = new Intent(getActivity(), RPRedPacketActivity.class);
            intent.putExtra(RPConstant.EXTRA_RED_PACKET_INFO, redPacketInfo);
            TokenData tokenData = new TokenData();
            tokenData.appUserId = clientUser.getUserId();
            intent.putExtra(RPConstant.EXTRA_TOKEN_DATA, tokenData);
            startActivityForResult(intent, RedPacketUtil.REQUEST_CODE_SEND_MONEY);
            hideBottomPanel();
        }

    }
</code></pre>

<ul>
<li>在ChattingFragment.java中发红红包消息</li>
</ul>


<pre><code>
    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);

        ...

        if (requestCode == RedPacketUtil.REQUEST_CODE_SEND_MONEY) {
            if (data != null) {
                handleSendRedPacketMessage(data);
            }
        }

    }

     /**
     * 发送红包消息
     */
    private void handleSendRedPacketMessage(Intent data) {
        try {
            String greetings = data.getStringExtra(RPConstant.EXTRA_RED_PACKET_GREETING);
            String moneyID = data.getStringExtra(RPConstant.EXTRA_RED_PACKET_ID);
            String specialReceiveId = data.getStringExtra(RPConstant.EXTRA_RED_PACKET_RECEIVER_ID);
            String redPacketType = data.getStringExtra(RPConstant.EXTRA_RED_PACKET_TYPE);
            String text = "[" + getResources().getString(R.string.ytx_luckymoney) + "]" + greetings;
            JSONObject jsonObject = new JSONObject();
            jsonObject.put(RPConstant.MESSAGE_ATTR_IS_RED_PACKET_MESSAGE, true);//是否是红包消息
            jsonObject.put(RPConstant.EXTRA_SPONSOR_NAME,getResources().
            getString(R.string.ytx_luckymoney));//红包
            jsonObject.put(RPConstant.EXTRA_RED_PACKET_GREETING, greetings);//祝福语
            jsonObject.put(RPConstant.EXTRA_RED_PACKET_ID, moneyID);//红包id
            jsonObject.put(RPConstant.MESSAGE_ATTR_RED_PACKET_TYPE, redPacketType);//红包类型，专属红包
            jsonObject.put(RPConstant.MESSAGE_ATTR_SPECIAL_RECEIVER_ID, specialReceiveId);//指定接收者
            // 组建一个待发送的ECMessage
            ECMessage msg = ECMessage.createECMessage(ECMessage.Type.TXT);
            // 设置消息接收者
            msg.setTo(mRecipients);
            msg.setUserData(jsonObject.toString());
            // 创建一个文本消息体，并添加到消息对象中
            ECTextMessageBody msgBody = new ECTextMessageBody(text.toString());
            msg.setBody(msgBody);
            String[] at = mChattingFooter.getAtSomeBody();
            msgBody.setAtMembers(at);
            mChattingFooter.clearSomeBody();
            // 发送消息，该函数见上
            long rowId = -1;
            if (mCustomerService) {
                rowId = CustomerServiceHelper.sendMCMessage(msg);
            } else {
                rowId = IMChattingHelper.sendECMessage(msg);
            }
            // 通知列表刷新
            msg.setId(rowId);
            notifyIMessageListView(msg);
        } catch (JSONException e) {
            e.printStackTrace();
        }

    }
</code></pre>

<h3>2.6 在ChattingFragment增加专属红包（不需要的话可以不加）</h3>

<pre><code>
    package com.yuntongxun.ecdemo.ui.chatting

    /**
     * @param mRecipients
     */
    private void initSettings(String mRecipients) {
        if (isPeerChat()) {
            ECGroup ecGroup = GroupSqlManager.getECGroup(mRecipients);
            if (ecGroup != null) {
                setActionBarTitle(ecGroup.getName() != null ? ecGroup.getName() : ecGroup.getGroupId());
                SpannableString charSequence = setNewMessageMute(!ecGroup.isNotice());
                if (charSequence != null) {
                    getTopBarView().setTitle(charSequence);
                }
            }
            //专属红包
            RedPacketUtil.getInstance().setGroupMember(ecGroup.getGroupId());
        }
    }
</code></pre>

<h3>2.7 增加四种消息item类型：收/发红包消息,收/发红包领取回执消息</h3>

<ul>
<li>在ChattingListAdapter2.java</li>
</ul>


<pre><code>     package com.yuntongxun.ecdemo.ui.chatting;
     /**
     * 初始化不同的聊天Item View
     */
    void initRowItems() {
        ...
        mRowItems.put(Integer.valueOf(16), new RedPacketRxRow(16));
        mRowItems.put(Integer.valueOf(17), new RedPacketTxRow(17));
        mRowItems.put(Integer.valueOf(18), new RedPacketAckRxRow(18));
        mRowItems.put(Integer.valueOf(19), new RedPacketAckTxRow(19));
    }
</code></pre>

<ul>
<li>在ChattingRowType.java</li>
</ul>


<pre><code>
    package com.yuntongxun.ecdemo.ui.chatting.mode  

    /**
     * redpacket recieve
     */
    REDPACKET_ROW_RECEIVED("C7000R", Integer.valueOf(16)),

    /**
     * redpacket send
     */
    REDPACKE_ROW_TO("C7000T", Integer.valueOf(17)),
    /**
     * redpacket ack
     */
    REDPACKE_ROW_ACK_RECEIVED("C8000R", Integer.valueOf(18)),
    REDPACKE_ROW_ACK_TO("C8000T", Integer.valueOf(19));
</code></pre>

<ul>
<li>在ChattingsRowUtils.java中的Text消息类型下分出四类红包相关消息参数</li>
</ul>


<pre><code>
    package com.yuntongxun.ecdemo.ui.chatting

    public static int getChattingMessageType(ECMessage ecMessage) {
        ECMessage.Type type = ecMessage.getType();
        if (type == ECMessage.Type.TXT) {
            if (RedPacketUtil.getInstance().isRedPacketMessage(ecMessage) != null) {
                return 7000;
            } else if (RedPacketUtil.getInstance().isRedPacketAckMessage(ecMessage) != null) {
                return 8000;
            }
            return 2000;
        } 

        ...

        return 2000;
    }

    /**
     * @param iMessage
     * @return
     */
    public static Integer getMessageRowType(ECMessage iMessage) {
        ECMessage.Type type = iMessage.getType();
        ECMessage.Direction direction = iMessage.getDirection();
        if (type == ECMessage.Type.TXT) {
            if (direction == ECMessage.Direction.RECEIVE) {
                if (RedPacketUtil.getInstance().isRedPacketMessage(iMessage) != null) {
                    return ChattingRowType.REDPACKET_ROW_RECEIVED.getId();
                } else if (RedPacketUtil.getInstance().isRedPacketAckMessage(iMessage) != null) {
                    return ChattingRowType.REDPACKE_ROW_ACK_RECEIVED.getId();
                }
                return ChattingRowType.DESCRIPTION_ROW_RECEIVED.getId();
            } else {
                if (RedPacketUtil.getInstance().isRedPacketMessage(iMessage) != null) {
                    return ChattingRowType.REDPACKE_ROW_TO.getId();
                } else if (RedPacketUtil.getInstance().isRedPacketAckMessage(iMessage) != null) {
                    return ChattingRowType.REDPACKE_ROW_ACK_TO.getId();
                }
                return ChattingRowType.DESCRIPTION_ROW_TRANSMIT.getId();

            }

        }

        ...

        return -1;
    }
</code></pre>

<ul>
<li>增加两类holder和收发的四类chatRow--红包消息、红包领取回执消息</li>
</ul>


<pre><code>
    package com.yuntongxun.ecdemo.ui.chatting.holder;

    增加-&gt;RedPacketAckViewHolder.java/RedPacketViewHolder.java

    package com.yuntongxun.ecdemo.ui.chatting.model;

    增加-&gt;RedPacketRxRow.java/RedPacketTxRow.java/RedPacketAckRxRow.java/RedPacketAckTxRow.java 
</code></pre>

<h3>2.8 打开红包以及发送领取红包的回执消息</h3>

<ul>
<li>在ChattingListClickListener.java中打开红包</li>
</ul>


<pre><code>
    @Override
    public void onClick(View v) {
        ViewHolderTag holder = (ViewHolderTag) v.getTag();
        ECMessage iMessage = holder.detail;

        switch (holder.type) {

            ....

            case ViewHolderTag.TagType.TAG_IM_REDPACKET:
                //打开红包
                RedPacketUtil.getInstance().openRedPacket
                (mContext,iMessage,CCPAppManager.getClientUser());
                break;
            default:
                break;
        }
    }
</code></pre>

<ul>
<li>在ChattingFragment.java中发送回执消息</li>
</ul>


<pre><code>
      package com.yuntongxun.ecdemo.ui.chatting;

      public void sendRedPacketAckMessage(String senderId, String senderNickName) {
        JSONObject jsonObject = new JSONObject();
        try {
            jsonObject.put(RPConstant.MESSAGE_ATTR_IS_RED_PACKET_ACK_MESSAGE, true);//是否是红包领取消息
            jsonObject.put(RPConstant.EXTRA_RED_PACKET_SENDER_NAME, senderNickName);//发送者昵称
            jsonObject.put(RPConstant.EXTRA_RED_PACKET_SENDER_ID, senderId);//发送者id
            jsonObject.put(RPConstant.EXTRA_RED_PACKET_RECEIVER_NAME, 
            clientUser.getUserName());//接收者昵称
            jsonObject.put(RPConstant.EXTRA_RED_PACKET_RECEIVER_ID, clientUser.getUserId());//接收者id
            String text;
            if (senderId.equals(clientUser.getUserId())) {
                text = this.getResources().getString(R.string.money_msg_take_money);
            } else {
                text = String.format(getResources().getString
                (R.string.money_msg_take_someone_money), senderNickName);
            }
            // 组建一个待发送的ECMessage
            ECMessage msg = ECMessage.createECMessage(ECMessage.Type.TXT);
            // 设置消息接收者
            msg.setTo(mRecipients);
            msg.setUserData(jsonObject.toString());
            // 创建一个文本消息体，并添加到消息对象中
            ECTextMessageBody msgBody = new ECTextMessageBody(text.toString());
            msg.setBody(msgBody);
            String[] at = mChattingFooter.getAtSomeBody();
            msgBody.setAtMembers(at);
            mChattingFooter.clearSomeBody();
            // 发送消息，该函数见上
            long rowId = -1;
            if (mCustomerService) {
                rowId = CustomerServiceHelper.sendMCMessage(msg);
            } else {
                rowId = IMChattingHelper.sendECMessage(msg);
            }
            // 通知列表刷新
            msg.setId(rowId);
            notifyIMessageListView(msg);
        } catch (JSONException e) {
            e.printStackTrace();
        }
    }
</code></pre>

<ul>
<li>在IMChattingHelper中删除不是自己的回执消息</li>
</ul>


<pre><code>
    /**
     * 处理接收消息
     *
     * @param msg
     * @param showNotice
     */
    private synchronized void postReceiveMessage(ECMessage msg,boolean showNotice) {
        // 接收到的IM消息，根据IM消息类型做不同的处理
        // IM消息类型：ECMessage.Type
      if (msg.getType() == Type.TXT) {
            if (!RedPacketUtil.getInstance().isMyAckMessage(msg, CCPAppManager.getClientUser().getUserId())) {
                IMessageSqlManager.delSingleMsg(msg.getMsgId());
                return;
            }
            JSONObject jsonObject = RedPacketUtil.getInstance().isRedPacketAckMessage(msg);
            if (jsonObject != null) {
                //改写回执红包消息的内容
                String currentUserId = CCPAppManager.getClientUser().getUserId();//当前登陆用户id
                String receiveUserId = jsonObject.optString(RPConstant.EXTRA_RED_PACKET_RECEIVER_ID);//红包接收者id
                String receiveUserNick = jsonObject.optString(RPConstant.EXTRA_RED_PACKET_RECEIVER_NAME);//红包接收者昵称
                String sendUserId = jsonObject.optString(RPConstant.EXTRA_RED_PACKET_SENDER_ID);//红包发送者id
                String sendUserNick = jsonObject.optString(RPConstant.EXTRA_RED_PACKET_SENDER_NAME);//红包发送者昵称
                String text = "";
                //发送者和领取者都是自己-
                if (currentUserId.equals(receiveUserId) &amp;&amp; currentUserId.equals(sendUserId)) {
                    text = CCPAppManager.getContext().getResources().getString(R.string.money_msg_take_money);
                } else if (currentUserId.equals(sendUserId)) {
                    //我仅仅是发送者
                    text = String.format(CCPAppManager.getContext().getResources().getString(R.string.money_msg_someone_take_money), receiveUserNick);
                } else if (currentUserId.equals(receiveUserId)) {
                    //我仅仅是接收者
                    text = String.format(CCPAppManager.getContext().getResources().getString(R.string.money_msg_take_someone_money), sendUserNick);
                }
                ECTextMessageBody msgBody = new ECTextMessageBody(text.toString());
                msg.setBody(msgBody);
                //设置为不提醒
                showNotice = false;
            }
            //转账
            JSONObject transferObject = RedPacketUtil.getInstance().isTransferMsg(msg);
            if (transferObject != null) {
                //改写转账消息的内容
                String money = transferObject.optString(RPConstant.EXTRA_TRANSFER_AMOUNT);//转账金额
                String text = "[转账]向你转账" + money + "元";
                ECTextMessageBody msgBody = new ECTextMessageBody(text.toString());
                msg.setBody(msgBody);
                //设置为不提醒
                showNotice = true;
            }

        }

        ...

        // 是否状态栏提示
        if (showNotice) {
            showNotification(msg);
        }
    }
</code></pre>

<ul>
<li>在ConversationAdapter中去掉红包、回执消息显示发送者</li>
</ul>


<pre><code>     protected final CharSequence getConversationSnippet(Conversation conversation) {

     ...
        String fromNickName = "";
        if (conversation.getSessionId().toUpperCase().startsWith("G")) {
            if (conversation.getContactId() != null &amp;&amp; CCPAppManager.getClientUser() != null
                    &amp;&amp; !conversation.getContactId().equals(CCPAppManager.getClientUser().getUserId())) {
                ECContacts contact = ContactSqlManager.getContact(conversation.getContactId());
                if (contact != null &amp;&amp; contact.getNickname() != null) {
                    fromNickName = contact.getNickname() + ": ";
                } else {
                    fromNickName = conversation.getContactId() + ": ";
                }
                //用字符串的方式的识别红包消息，改变会话页显示样式
                if (conversation.getMsgType() == ECMessage.Type.TXT.ordinal()) {
                    String content = conversation.getContent();
                    if ((content.contains("领取了") &amp;&amp; content.contains("的红包")) || content.contains("红包消息")|| content.contains("容联云红包")) {

                        fromNickName = "";
                    }
                }
            }
        }

       ...

        return snippet;
    }
</code></pre>

<h3>2.9 在SettingsActivity.java添加零钱页的入口</h3>

<ul>
<li>在SettingsActivity.java*</li>
</ul>


<pre><code>
    package com.yuntongxun.ecdemo.ui.settings

    RedPacketUtil.getInstance().toChangeActivity(this);

     settings_money = (SettingItem) this.findViewById(R.id.settings_money);
        settings_money.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                RedPacketUtil.getInstance().startChangeActivity(SettingsActivity.this, CCPAppManager.getClientUser());
            }
        });
</code></pre>

<h2>3. 集成转账功能</h2>

<h3>3.1 在聊天页扩展消息类型中增加“转账”的发送入口</h3>

<ul>
<li>在AppPanelControl.java中增加消息扩展栏红包的按钮</li>
</ul>


<pre><code>    package com.yuntongxun.ecdemo.ui.chatting;

    public int[] capVoip = new int[] { ...,R.string.attach_transfer,...};
    private Capability getCapability(int resid) {

       Capability capability = null;

        switch (resid) {
        ...
        ...
          //转账按钮
        case R.string.attach_transfer:
        capability = new Capability(getContext().getString(
        R.string.attach_transfer), R.drawable.ytx_chat_transfer_selector);

        break;

        default:

        break;
        }   
</code></pre>

<ul>
<li>在AppPanel.java设置红包按钮的监听事件。</li>
</ul>


<pre><code>
    package com.yuntongxun.ecdemo.ui.chatting.vew;

       final AppGrid.OnCapabilityItemClickListener mCapabilityItemClickListener
            = new AppGrid.OnCapabilityItemClickListener() {

        @Override
        public void onPanleItemClick(int index, int capabilityId, String capabilityName) {
           ....
            switch (capabilityId) {
                   ...
                    case R.string.attach_transfer:
                    mAppPanelItemClickListener.OnSelectTransferClick();
                    break;

                default:
                    break;
            }
        }
    };

    public interface OnAppPanelItemClickListener {
        .....
         void OnSelectTransferClick();

    }
</code></pre>

<ul>
<li>在CCPChattingFooter2中设置</li>
</ul>


<pre><code>
    package com.yuntongxun.ecdemo.ui.chatting.view;

    final private AppPanel.OnAppPanelItemClickListener  mAppPanelItemClickListener
            = new AppPanel.OnAppPanelItemClickListener() {

        @Override
        public void OnTakingPictureClick() {
        .........

        @Override
        public void OnSelectRedPacketClick() {
            @Override
        public void OnSelectTransferClick() {
            // TODO Auto-generated method stub
            if (mChattingPanelClickListener != null) {
                mChattingPanelClickListener.OnSelectTransferRequest();
            }
        }

        }

    };
</code></pre>

<h3>3.2 打开转账界面以及发送转账消息</h3>

<ul>
<li>在ChattingFragment.java中点击红包按钮打开发送红包界面</li>
</ul>


<pre><code>
      package com.yuntongxun.ecdemo.ui.chatting;

     /**
     * 聊天插件功能实现
     */
    private class OnOnChattingPanelImpl implements CCPChattingFooter2.OnChattingPanelClickListener {

    ...

    @Override
        public void OnSelectTransferRequest() {//转账
            RedPacketInfo redPacketInfo=new RedPacketInfo();
            //传递参数到红包sdk：发送者头像url，昵称（缺失则传id）
            String fromNickName = clientUser.getUserName();
            fromNickName = TextUtils.isEmpty(fromNickName) ? 
            clientUser.getUserId() : fromNickName;
            redPacketInfo.fromAvatarUrl = "none";//发送者头像//开发者换成自己app的图像
            redPacketInfo.fromNickName = fromNickName;//发送者昵称
            //接收者
            redPacketInfo.toUserId = mRecipients;
            ECContacts contact = ContactSqlManager.getContact(mRecipients);
            if (contact!=null){
                redPacketInfo.toNickName = contact.getNickname();
            }else {
                redPacketInfo.toNickName=mRecipients;
            }
            redPacketInfo.toAvatarUrl = "none";//开发者换成自己app的图像
            TokenData tokenData = new TokenData();
            tokenData.appUserId = clientUser.getUserId();
            Intent intent = new Intent(getActivity(), RPRedTransferActivity.class);
            intent.putExtra(RPConstant.EXTRA_TRANSFER_PACKET_INFO, redPacketInfo);
            intent.putExtra(RPConstant.EXTRA_TOKEN_DATA, tokenData);
            startActivityForResult(intent, RedPacketUtil.REQUEST_CODE_SEND_TRANSFER);
        }
    }
</code></pre>

<ul>
<li>在ChattingFragment.java中发红红包消息</li>
</ul>


<pre><code>
    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);

        ...

        if (requestCode == RedPacketUtil.REQUEST_CODE_SEND_TRANSFER) {//转账
            if (data != null) {
                handleSendTransferMessage(data);
            }
        }

    }

     /**
     * 发送转账消息
     */
    private void handleSendTransferMessage(Intent data) {
        try {
            String money = data.getStringExtra(RPConstant.EXTRA_TRANSFER_AMOUNT);
            String time = data.getStringExtra(RPConstant.EXTRA_TRANSFER_PACKET_TIME);
            String text = "[" + getResources().getString(R.string.attach_transfer) + "]";
            JSONObject jsonObject = new JSONObject();
            jsonObject.put(RPConstant.MESSAGE_ATTR_IS_TRANSFER_PACKET_MESSAGE, true);//是否是转账消息
            jsonObject.put(RPConstant.EXTRA_TRANSFER_AMOUNT, money);//转账金额
            jsonObject.put(RPConstant.EXTRA_TRANSFER_PACKET_TIME, time);//转账时间
            // 组建一个待发送的ECMessage
            ECMessage msg = ECMessage.createECMessage(ECMessage.Type.TXT);
            // 设置消息接收者
            msg.setTo(mRecipients);
            msg.setUserData(jsonObject.toString());
            // 创建一个文本消息体，并添加到消息对象中
            ECTextMessageBody msgBody = new ECTextMessageBody(text.toString());
            msg.setBody(msgBody);
            String[] at = mChattingFooter.getAtSomeBody();
            msgBody.setAtMembers(at);
            mChattingFooter.clearSomeBody();
            // 发送消息，该函数见上
            long rowId;
            if (mCustomerService) {
                rowId = CustomerServiceHelper.sendMCMessage(msg);
            } else {
                rowId = IMChattingHelper.sendECMessage(msg);
            }
            // 通知列表刷新
            msg.setId(rowId);
            notifyIMessageListView(msg);
        } catch (JSONException e) {
            e.printStackTrace();
        }

    }    
</code></pre>

<h3>3.3 增加两种消息item类型：收/发转账消息</h3>

<ul>
<li>在ChattingListAdapter.java</li>
</ul>


<pre><code>     package com.yuntongxun.ecdemo.ui.chatting;
     /**
     * 初始化不同的聊天Item View
     */
    void initRowItems() {
        ...
        mRowItems.put(Integer.valueOf(20), new TransferRxRow(20));
        mRowItems.put(Integer.valueOf(21), new TransferTxRow(21));
    }
</code></pre>

<ul>
<li>在ChattingRowType.java</li>
</ul>


<pre><code>
    package com.yuntongxun.ecdemo.ui.chatting.mode     

    /**
     * transfer
     */
    TRANSFER_ROW_RECEIVED("C9000R", Integer.valueOf(20)),
    TRANSFER_ROW_TO("C9000T", Integer.valueOf(21));
</code></pre>

<ul>
<li>在ChattingsRowUtils.java中的Text消息类型下分出四类红包相关消息参数</li>
</ul>


<pre><code>
    package com.yuntongxun.ecdemo.ui.chatting

    public static int getChattingMessageType(ECMessage ecMessage) {
        ECMessage.Type type = ecMessage.getType();
         if (RedPacketUtil.getInstance().isRedPacketMessage(ecMessage) != null) {//红包
                return 7000;
            } else if (RedPacketUtil.getInstance().
            isRedPacketAckMessage(ecMessage) != null) {//回执消息
                return 8000;
            } else if (RedPacketUtil.getInstance().isTransferMsg(ecMessage) != null) {//转账
                return 9000;
            }
            return 2000;

        ...

        return 2000;
    }              
</code></pre>

<ul>
<li>增加收发转账chatRow</li>
</ul>


<pre><code>
    package com.yuntongxun.ecdemo.ui.chatting.holder;

    增加-&gt;TransferViewHolder.java

    package com.yuntongxun.ecdemo.ui.chatting.model;

    增加-&gt;TransferRxRow.java/TransferTxRow.java
</code></pre>

<h3>3.4 查看转账详情</h3>

<ul>
<li>在ChattingListClickListener.java中打开红包</li>
</ul>


<pre><code>
    @Override
    public void onClick(View v) {
        ViewHolderTag holder = (ViewHolderTag) v.getTag();
        ECMessage iMessage = holder.detail;

        switch (holder.type) {

        ....
        case ViewHolderTag.TagType.TAG_IM_TRANSFER:
        //打开转账
        RedPacketUtil.getInstance().openTransfer(mContext,iMessage,CCPAppManager.getClientUser());
        break;
        default:
        break;
        }
    }
</code></pre>

<h1>4设置SDK BaseUrl</h1>

<pre><code> //设置baseUrl
 RedPacket.getInstance().initBaseUrl("http://10.10.1.10:32802");
</code></pre>
</body>
</html>